// components/district-page-client.tsx
"use client"

import { useState, useRef, useLayoutEffect, useEffect, Suspense, forwardRef } from "react"
// **FIXED/ADDED Next.js Imports for Navigation**
import { useRouter, usePathname, useSearchParams } from "next/navigation" 
import { MetricCard } from "@/components/metric-card" 
import { TrendChart } from "@/components/trend-chart"
import { Comparison } from "@/components/comparison"
import HomeButton from "@/components/home-button"
import { Card, CardContent } from "@/components/ui/card"
import { Button } from "@/components/ui/button"

// --- Type Definitions (Must match data structure) ---
type MetricsData = { updatedAtHuman: string; stale: boolean; cards: Record<string, any>; };
type TrendData = Array<{ year: number; month: number; persondays: number; householdsWorked: number; wageExpenditure: number }>;

// Metric Card Specifications (used for mapping the MetricCards)
const metricCardsList = [
Â  Â  { title: "Persondays", subtitle: "à¤•à¤¾à¤® à¤•à¥‡ à¤¦à¤¿à¤¨", value: "persondays", help: "Total persondays generated." },
Â  Â  { title: "Households Worked", subtitle: "à¤•à¤¾à¤® à¤•à¤°à¤¨à¥‡ à¤µà¤¾à¤²à¥‡ à¤ªà¤°à¤¿à¤µà¤¾à¤°", value: "householdsWorked", help: "Households that worked in the month." },
Â  Â  { title: "Avg Days/HH", subtitle: "à¤”à¤¸à¤¤ à¤¦à¤¿à¤¨/à¤ªà¤°à¤¿à¤µà¤¾à¤°", value: "avgDaysPerHH", help: "Average days of employment per household." },
Â  Â  { title: "Wage Expenditure", subtitle: "à¤®à¤œà¤¦à¥‚à¤°à¥€ à¤–à¤°à¥à¤š", value: "wageExpenditure", help: "Total wage expenditure in â‚¹.", format: "currency" as const },
Â  Â  { title: "Total Workers", subtitle: "à¤•à¥à¤² à¤•à¤¾à¤®à¤—à¤¾à¤°", value: "totalWorkers", help: "Total number of workers employed." },
Â  Â  { title: "Women Persondays", subtitle: "à¤®à¤¹à¤¿à¤²à¤¾ à¤¦à¤¿à¤¨", value: "womenPersondays", help: "Total persondays generated by women." },
Â  Â  { title: "Avg Wage Rate", subtitle: "à¤”à¤¸à¤¤ à¤®à¤œà¤¦à¥‚à¤°à¥€ à¤¦à¤°", value: "avgWageRate", help: "Average wage rate per day per person.", format: "currency" as const },
Â  Â  { title: "Completed Works", subtitle: "à¤ªà¥‚à¤°à¤¾ à¤¹à¥à¤† à¤•à¤¾à¤®", value: "numCompletedWorks", help: "Number of works completed." },
Â  Â  { title: "Ongoing Works", subtitle: "à¤šà¤² à¤°à¤¹à¥‡ à¤•à¤¾à¤®", value: "numOngoingWorks", help: "Number of works currently ongoing." },
Â  Â  { title: "SC Persondays", subtitle: "à¤…à¤¨à¥à¤¸à¥‚à¤šà¤¿à¤¤ à¤œà¤¾à¤¤à¤¿ à¤¦à¤¿à¤¨", value: "scPersondays", help: "Persondays generated by Scheduled Caste workers." },
Â  Â  { title: "ST Persondays", subtitle: "à¤…à¤¨à¥à¤¸à¥‚à¤šà¤¿à¤¤ à¤œà¤¨à¤œà¤¾à¤¤à¤¿ à¤¦à¤¿à¤¨", value: "stPersondays", help: "Persondays generated by Scheduled Tribe workers." },
Â  Â  { title: "Total Expenditure", subtitle: "à¤•à¥à¤² à¤–à¤°à¥à¤š", value: "totalExpenditure", help: "Total expenditure in â‚¹.", format: "currency" as const },
Â  Â  { title: "Admin Expenditure", subtitle: "à¤ªà¥à¤°à¤¶à¤¾à¤¸à¤¨à¤¿à¤• à¤–à¤°à¥à¤š", value: "totalAdminExpenditure", help: "Total administrative expenditure in â‚¹.", format: "currency" as const },
Â  Â  { title: "Job Cards Issued", subtitle: "à¤œà¥‰à¤¬ à¤•à¤¾à¤°à¥à¤¡ à¤œà¤¾à¤°à¥€", value: "totalJobCardsIssued", help: "Number of job cards issued." },
Â  Â  { title: "Active Job Cards", subtitle: "à¤¸à¤•à¥à¤°à¤¿à¤¯ à¤œà¥‰à¤¬ à¤•à¤¾à¤°à¥à¤¡", value: "totalActiveJobCards", help: "Number of active job cards." },
Â  Â  { title: "Active Workers", subtitle: "à¤¸à¤•à¥à¤°à¤¿à¤¯ à¤•à¤¾à¤®à¤—à¤¾à¤°", value: "totalActiveWorkers", help: "Number of active workers." },
Â  Â  { title: "Works Taken Up", subtitle: "à¤¶à¥à¤°à¥‚ à¤•à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾ à¤•à¤¾à¤®", value: "totalWorksTakenup", help: "Number of works taken up this month." },
Â  Â  { title: "HHS Completed 100 Days", subtitle: "100 à¤¦à¤¿à¤¨ à¤ªà¥‚à¤°à¥‡ à¤•à¤¿à¤ à¤ªà¤°à¤¿à¤µà¤¾à¤°", value: "totalHhsCompleted100Days", help: "Households that completed 100 days of employment." },
Â  Â  { title: "Material & Skilled Wages", subtitle: "à¤¸à¤¾à¤®à¤—à¥à¤°à¥€ à¤”à¤° à¤•à¥à¤¶à¤² à¤®à¤œà¤¦à¥‚à¤°à¥€", value: "materialAndSkilledWages", help: "Expenditure on material and skilled wages.", format: "currency" as const },
Â  Â  { title: "Differently Abled Worked", subtitle: "à¤µà¤¿à¤•à¤²à¤¾à¤‚à¤— à¤•à¤¾à¤®à¤—à¤¾à¤°", value: "differentlyAbledPersonsWorked", help: "Number of differently abled persons who worked." },
];

function monthLabel(m: number) {
Â  return new Date(2000, m - 1, 1).toLocaleString("en-IN", { month: "long" })
}

// **New Year Options Logic**
const currentYear = new Date().getFullYear();
const yearOptions = Array.from({ length: 5 }, (_, i) => currentYear - i);

// ğŸš€ The main Client Component
export function DistrictPageClient({
Â  Â  stateName,
Â  Â  districtName,
Â  Â  month,
Â  Â  year,
Â  Â  metrics,
Â  Â  trend,
}: {
Â  Â  stateName: string;
Â  Â  districtName: string;
Â  Â  month: number;
Â  Â  year: number;
Â  Â  metrics: MetricsData;
Â  Â  trend: TrendData;
}) {
    // **ADDED Next.js Navigation Hooks**
    const router = useRouter();
    const pathname = usePathname();
    const searchParams = useSearchParams();

Â  Â  const [step, setStep] = useState(0);
Â  Â  const [showOverlay, setShowOverlay] = useState(false);
Â  Â  const [tooltipPos, setTooltipPos] = useState<{ top: number; left: number } | null>(null);

Â  Â  // Refs for the elements we want to highlight
Â  Â  const homeButtonRef = useRef<HTMLDivElement>(null);
Â  Â  const trendChartRef = useRef<HTMLDivElement>(null);
Â  Â  const comparisonRef = useRef<HTMLDivElement>(null);
Â  Â  const persondaysMetricRef = useRef<HTMLDivElement>(null);
Â  Â  const wageExpenditureMetricRef = useRef<HTMLDivElement>(null);

Â  Â  // Steps for the guided tour/demo
Â  Â  const steps = [
Â  Â  Â  Â  { ref: homeButtonRef, text: "Demo Step 1: Click the Home Button to easily navigate back to the state selection page." },
Â  Â  Â  Â  { ref: trendChartRef, text: "Demo Step 2: The 12-Month Trend chart provides a historical context for the district's performance across key metrics." },
Â  Â  Â  Â  { ref: comparisonRef, text: "Demo Step 3: Use the Comparison panel to select up to two other districts and benchmark performance." },
Â  Â  ];

Â  Â  const isActive = (ref: React.RefObject<any>) => steps[step]?.ref === ref;

Â  Â  // ğŸš€ Auto-start the tour once on mount (kept the same)
Â  Â  useEffect(() => {
Â  Â  Â  Â  if (typeof window === "undefined") return
Â  Â  Â  Â  const visitedKey = `visited_district_page_tour`;
Â  Â  Â  Â  const visited = localStorage.getItem(visitedKey);
Â  Â  Â  Â  
Â  Â  Â  Â  if (!visited) {
Â  Â  Â  Â  Â  Â  setShowOverlay(true);
Â  Â  Â  Â  Â  Â  localStorage.setItem(visitedKey, "true");
Â  Â  Â  Â  }
Â  Â  }, []);

Â  Â  // ğŸš€ useLayoutEffect logic to handle positioning AND scrolling for every step (kept the same)
Â  Â  useLayoutEffect(() => {
Â  Â  Â  Â  if (!showOverlay || step >= steps.length) {
Â  Â  Â  Â  Â  Â  setTooltipPos(null);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const currentRef = steps[step]?.ref.current;
Â  Â  Â  Â  if (!currentRef) {
Â  Â  Â  Â  Â  Â  setTooltipPos(null);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  currentRef.scrollIntoView({ behavior: 'smooth', block: 'center' });

Â  Â  Â  Â  const calculatePosition = () => {
Â  Â  Â  Â  Â  Â  const rect = currentRef.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  const offset = 10;
Â  Â  Â  Â  Â  Â  const scrollY = window.scrollY;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  setTooltipPos({
Â  Â  Â  Â  Â  Â  Â  Â  top: rect.bottom + scrollY + offset,
Â  Â  Â  Â  Â  Â  Â  Â  left: rect.left + rect.width / 2,
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };

Â  Â  Â  Â  const id = requestAnimationFrame(calculatePosition);
Â  Â  Â  Â  return () => cancelAnimationFrame(id);

Â  Â  }, [step, showOverlay, steps.length]);


// In components/district-page-client.tsx
function nextStep() {
Â  Â  if (step < steps.length - 1) {
Â  Â  Â  Â  console.log(`Moving from step ${step + 1} to step ${step + 2}`); 
Â  Â  Â  Â  setStep(step + 1); 
Â  Â  }
Â  Â  else if (step === steps.length - 1) {
Â  Â  Â  Â  console.log("Tour finished. Closing overlay.");
Â  Â  Â  Â  setShowOverlay(false);
Â  Â  }
Â  Â  else {
Â  Â  Â  Â  setShowOverlay(false);
Â  Â  }
}

function closeTooltip() {
Â  Â  setShowOverlay(false)
}

const getMetricRef = (valueKey: string) => {
Â  Â  if (valueKey === 'persondays') return persondaysMetricRef;
Â  Â  if (valueKey === 'wageExpenditure') return wageExpenditureMetricRef;
Â  Â  return undefined;
};

// **New Year Change Handler Logic**
const handleYearChange = (event: React.ChangeEvent<HTMLSelectElement>) => {
    const newYear = event.target.value;
    const currentSearchParams = new URLSearchParams(searchParams.toString());
    currentSearchParams.set('year', newYear);
    // When the year changes, it's safer to remove the month parameter 
    // to prevent fetching data for a combination that doesn't exist (e.g., future month in past year).
    currentSearchParams.delete('month'); 
    router.push(`${pathname}?${currentSearchParams.toString()}`);
};
    return (
        <main className="min-h-dvh relative">
            {/* Overlay */}
            {showOverlay && <div className="fixed inset-0 bg-black/30 backdrop-blur-sm z-40" />}

            {/* Header */}
<header className={`w-full border-b bg-card relative z-50 ${!isActive(homeButtonRef) && showOverlay ? "blur-sm pointer-events-none" : ""}`}>
    <div className="mx-auto max-w-5xl px-4 py-4 flex flex-col md:flex-row md:items-center md:justify-between **gap-4**">
            <div ref={homeButtonRef as React.RefObject<HTMLDivElement>} className={`${isActive(homeButtonRef) ? "relative z-50" : ""} **mr-4**`}> 
                <HomeButton /> 
            </div>

        {/* Left Group (Title & Home) - Vertically Centered */}
        <div className="flex items-center">
            {/* Wrapper for HomeButton to attach ref */}
            
            {/* Title Block - Left-aligned text */}
            <div className="flex flex-col **items-start** min-w-0">
                <h1 className="text-xl font-semibold **truncate**">
                    {districtName}, {stateName}
                </h1>
                <span className="text-sm text-muted-foreground">
                    MGNREGA Performance â€” {monthLabel(month)} {year} / à¤®à¤¨à¤°à¥‡à¤—à¤¾ à¤ªà¥à¤°à¤¦à¤°à¥à¤¶à¤¨
                </span>
            </div>
        </div>

        {/* Right Group (Year & Update Info) - Vertically Stacked and Right-aligned on Desktop */}
        <div className="flex flex-col **items-start md:items-end** text-sm text-muted-foreground **mt-4 md:mt-0** **gap-2**">
            
            {/* Year Selector */}
            <div className="flex items-center gap-2 text-sm text-foreground">
                <label htmlFor="year-select" className="font-medium text-muted-foreground">Data Year:</label>
                <select
                    id="year-select"
                    value={year} 
                    onChange={handleYearChange}
                    className="border rounded-md px-2 py-1 text-sm bg-background/50 border-foreground/30 disabled:opacity-50"
                    disabled={showOverlay} 
                >
                    {yearOptions.map(y => (
                        <option key={y} value={y}>{y}</option>
                    ))}
                </select>
            </div>
            
            {/* Last Updated Info */}
            <p className="text-xs">{`Last updated: ${metrics.updatedAtHuman}`}</p>
            {metrics.stale && (
                <p className="text-destructive text-xs">
                    Showing last known data due to API issues.
                </p>
            )}
        </div>
    </div>
</header>            
            {/* Trend and Comparison */}
            <section className="mx-auto max-w-5xl px-4 pb-6 mt-6 grid gap-4 lg:grid-cols-3">
                
                {/* Trend chart */}
                <Card 
                    className={`lg:col-span-2 border-2 relative z-50 ${!isActive(trendChartRef) && showOverlay ? "blur-sm pointer-events-none" : ""}`} 
                    ref={trendChartRef as React.RefObject<HTMLDivElement>}
                >
                    <CardContent className="p-4">
                        <h2 className="text-lg font-semibold text-pretty mb-2">
                            12-Month Trend / 12 à¤®à¤¾à¤¹ à¤•à¤¾ à¤°à¥à¤à¤¾à¤¨
                        </h2>
                        <div className="h-[220px] flex">
                            <div className="w-full">
                                <Suspense fallback={<div className="text-sm text-muted-foreground">Loading chart...</div>}>
                                    <TrendChart data={trend} />
                                </Suspense>
                            </div>
                        </div>
                    </CardContent>
                </Card>

                {/* Comparison */}
                <Card 
                    className={`border-2 relative z-50 ${!isActive(comparisonRef) && showOverlay ? "blur-sm pointer-events-none" : ""}`} 
                    ref={comparisonRef as React.RefObject<HTMLDivElement>}
                >
                    <CardContent className="p-4">
                        <h2 className="text-lg font-semibold text-pretty mb-2">Compare / à¤¤à¥à¤²à¤¨à¤¾</h2>
                    <Comparison
                    stateName={stateName}
                    districtName={districtName}
                    month={month}
                    year={year}
                    />
                    </CardContent>
                </Card>
            </section>

            {/* Metrics */}
            <section className="mx-auto max-w-5xl px-4 py-6 grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                {metricCardsList.map((card) => (
                    // Attach the ref and dynamic class to the MetricCard
                    <MetricCard 
                        key={card.title}
                        // Ref is attached here
                        ref={getMetricRef(card.value)}
                        title={card.title}
                        subtitle={card.subtitle}
                        value={metrics.cards[card.value]}
                        help={card.help}
                        format={card.format}
                        // Class is used to blur non-active elements during the tour
                        className={`relative z-50 ${!isActive(getMetricRef(card.value)) && showOverlay ? "blur-sm pointer-events-none" : ""}`}
                    />
                ))}
            </section>

            {/* Tooltip/Demo UI */}
            {showOverlay && tooltipPos && (
                <div
                    style={{ top: tooltipPos.top, left: tooltipPos.left, transform: 'translateX(-50%)' }}
                    className="fixed z-[60] bg-blue-800 border-2 border-blue-400 text-white p-4 rounded-lg shadow-2xl pointer-events-auto max-w-xs transition-all duration-300"
                >
                    <p>{steps[step].text}</p>
                    <div className="flex justify-between gap-2 mt-3">
                        <span className="text-sm text-gray-300 self-center">Step {step + 1} of {steps.length}</span>
                        <div className="flex gap-2">
                            <Button size="sm" variant="outline" onClick={closeTooltip} className="bg-white text-blue-800 border-blue-400 hover:bg-gray-100">
                                Skip
                            </Button>
                            <Button size="sm" onClick={nextStep} className="bg-blue-400 text-white hover:bg-blue-300">
                                {step < steps.length - 1 ? "Next" : "Finish"}
                            </Button>
                        </div>
                    </div>
                </div>
            )}
        </main>
    );
}
